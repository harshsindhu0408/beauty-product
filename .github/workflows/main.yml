name: Fetch PM2 logs (manual)

on:
  workflow_dispatch:

jobs:
  fetch-logs:
    runs-on: ubuntu-latest
    steps:
      - name: Decode SSH key
        run: |
          echo "$SSH_PRIVATE_KEY_B64" | base64 --decode > /tmp/deploy_key
          chmod 600 /tmp/deploy_key
        env:
          SSH_PRIVATE_KEY_B64: ${{ secrets.SSH_PRIVATE_KEY_B64 }}

      - name: Prepare known_hosts (optional)
        run: |
          if [ -n "${{ secrets.KNOWN_HOSTS }}" ]; then
            echo "${{ secrets.KNOWN_HOSTS }}" > /tmp/known_hosts
          else
            # fallback: disable strict host checking (less secure)
            echo "NO_KNOWN_HOSTS"
          fi

      - name: Fetch logs from server via SSH
        run: |
          set -e
          SSH_OPTS="-i /tmp/deploy_key -o UserKnownHostsFile=/tmp/known_hosts -o StrictHostKeyChecking=no -o ConnectTimeout=10 -o BatchMode=yes"
          echo "Connecting to ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.SSH_PORT || '22' }}"
          ssh $SSH_OPTS -p ${{ secrets.SSH_PORT || '22' }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            set -e
            echo "===== pm2 status ====="
            pm2 status || true
            echo

            echo "===== last 300 lines: api-server stdout ====="
            tail -n 300 /home/${USER:-ubuntu}/.pm2/logs/api-server-out.log || echo "api-server stdout log not found"
            echo

            echo "===== last 300 lines: api-server stderr ====="
            tail -n 300 /home/${USER:-ubuntu}/.pm2/logs/api-server-error.log || echo "api-server error log not found"
            echo

            echo "===== last 300 lines: saundrya-app stdout ====="
            tail -n 300 /home/${USER:-ubuntu}/.pm2/logs/saundrya-app-out.log || echo "saundrya-out not found"
            echo

            echo "===== last 300 lines: saundrya-app stderr ====="
            tail -n 300 /home/${USER:-ubuntu}/.pm2/logs/saundrya-app-error.log || echo "saundrya-error not found"
            echo

            echo "===== Nginx test and journal (last 100 lines) ====="
            sudo nginx -t || true
            sudo systemctl status nginx --no-pager || true
            sudo journalctl -u nginx -n 100 --no-pager || true

        env:
          # ensure secrets available to step (not printed)
          SSH_PRIVATE_KEY_B64: ${{ secrets.SSH_PRIVATE_KEY_B64 }}
