name: Fetch PM2 logs (manual)

on:
  workflow_dispatch:

jobs:
  fetch-logs:
    runs-on: ubuntu-latest
    steps:
      - name: Decode SSH key
        run: |
          echo "$SSH_PRIVATE_KEY_B64" | base64 --decode > /tmp/deploy_key
          chmod 600 /tmp/deploy_key
        env:
          SSH_PRIVATE_KEY_B64: ${{ secrets.SSH_PRIVATE_KEY_B64 }}

      - name: Fetch logs from server via SSH
        run: |
          set -e
          
          SSH_OPTS="-i /tmp/deploy_key \
                    -o StrictHostKeyChecking=no \
                    -o UserKnownHostsFile=/dev/null \
                    -o BatchMode=yes \
                    -o ConnectTimeout=10"
          
          ssh $SSH_OPTS \
            -p ${{ secrets.SSH_PORT || '22' }} \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            
            set -e

            echo "===== pm2 status ====="
            pm2 status || true
            echo

            echo "===== last 300 lines: api-server stdout ====="
            tail -n 300 /home/ubuntu/.pm2/logs/api-server-out.log || echo "stdout log not found"
            echo

            echo "===== last 300 lines: api-server stderr ====="
            tail -n 300 /home/ubuntu/.pm2/logs/api-server-error.log || echo "stderr log not found"
            echo

            echo "===== last 300 lines: saundrya-app stdout ====="
            tail -n 300 /home/ubuntu/.pm2/logs/saundrya-app-out.log || echo "stdout log not found"
            echo

            echo "===== last 300 lines: saundrya-app stderr ====="
            tail -n 300 /home/ubuntu/.pm2/logs/saundrya-app-error.log || echo "stderr log not found"
            echo

            echo "===== Nginx test & status ====="
            sudo nginx -t || true
            sudo systemctl status nginx --no-pager || true
            sudo journalctl -u nginx -n 100 --no-pager || true
EOF
